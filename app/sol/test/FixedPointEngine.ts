import { EthereumVirtualMachine } from "../../class/ethereumVirtualMachine/EthereumVirtualMachine.ts";
import { ethers as Ethers } from "ethers";
import { secret } from "../../class/host/Secret.ts";
import { SolFile } from "../../class/host/file/SolFile.ts";
import { File } from "../../class/host/file/File.ts";
import { Path } from "../../class/host/Path.ts";
import * as TsResult from "ts-results";

(async function() {
    let mainnetNodeUrl = "https://polygon-rpc.com";
    let testnetNodeUrl =  "https://rpc.tenderly.co/fork/32d6d64e-587c-47bf-9b50-98d37af5c16d";
    let nodeUrl = testnetNodeUrl;
    let key = secret("polygonPrivateKey");
    if (key.none) {
        err("Script: missing private key");
        return;
    }
    let node = new Ethers.JsonRpcProvider(nodeUrl);
    let signer = new Ethers.Wallet(key.unwrap(), node);
    let machine = EthereumVirtualMachine(signer);
    
    await (async function() {
        let factory = "0x5757371414417b8C6CAad45bAeF941aBc7d3Ab32";
        let router = "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff";
        let wmatic = "0x53E0bca35eC356BD5ddDFebbD1Fc0fD03FaBad39";
        let usdc = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359"; 

        let uniswapEngine = (await deploy(
            "",
            "6080604052348015600e575f80fd5b506133378061001c5f395ff3fe608060405234801561000f575f80fd5b50600436106100a7575f3560e01c80634c8d0af11161006f5780634c8d0af11461019b5780634ca69fcc146101cb57806355b86542146101fb57806379849f1f1461022b578063b718a0b01461025b578063c6ddba5e1461028b576100a7565b8063109acad7146100ab5780631cab9c4f146100db578063245ad5411461010b57806330df70261461013b5780633ee372801461016b575b5f80fd5b6100c560048036038101906100c09190612399565b6102bb565b6040516100d291906123e6565b60405180910390f35b6100f560048036038101906100f09190612399565b6102ce565b60405161010291906123e6565b60405180910390f35b61012560048036038101906101209190612399565b6102e1565b60405161013291906123e6565b60405180910390f35b61015560048036038101906101509190612459565b6102f4565b604051610162919061278b565b60405180910390f35b61018560048036038101906101809190612399565b610415565b60405161019291906123e6565b60405180910390f35b6101b560048036038101906101b09190612399565b610428565b6040516101c291906123e6565b60405180910390f35b6101e560048036038101906101e091906127cf565b61043b565b6040516101f291906123e6565b60405180910390f35b61021560048036038101906102109190612399565b610450565b60405161022291906123e6565b60405180910390f35b61024560048036038101906102409190612399565b610463565b60405161025291906123e6565b60405180910390f35b61027560048036038101906102709190612459565b610476565b604051610282919061282e565b60405180910390f35b6102a560048036038101906102a09190612399565b61058e565b6040516102b291906123e6565b60405180910390f35b5f6102c683836105a1565b905092915050565b5f6102d983836105c6565b905092915050565b5f6102ec8383610601565b905092915050565b6102fc612154565b610304612154565b8781602001515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508681602001516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505085816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505084816060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050838160c0018181525050828160e00181815250506104088161065d565b9150509695505050505050565b5f6104208383611404565b905092915050565b5f6104338383611429565b905092915050565b5f610447848484611485565b90509392505050565b5f61045b8383611588565b905092915050565b5f61046e83836115ad565b905092915050565b5f61047f612236565b87815f01515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505086815f01516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505085816020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505084816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508381606001818152505082816080018181525050610581816115c9565b9150509695505050505050565b5f6105998383611bba565b905092915050565b5f6105be68056bc75e2d631000006105b985856105c6565b611429565b905092915050565b5f8083036105d6575f90506105fb565b818310156105ed576105e88383611404565b6105f8565b68056bc75e2d631000005b90505b92915050565b5f805f61060e8585611bd6565b9150915081610652576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610649906128c7565b60405180910390fd5b809250505092915050565b610665612154565b5f8260c001511461067a578160c00151610684565b670de0b6b3a76400005b8260c00181815250505f8260e00151146106a2578160e001516106ac565b670de0b6b3a76400005b8260e00181815250505f73ffffffffffffffffffffffffffffffffffffffff16826040015173ffffffffffffffffffffffffffffffffffffffff16148061072257505f73ffffffffffffffffffffffffffffffffffffffff16826060015173ffffffffffffffffffffffffffffffffffffffff16145b8061075f57505f73ffffffffffffffffffffffffffffffffffffffff1682602001515f015173ffffffffffffffffffffffffffffffffffffffff16145b8061079d57505f73ffffffffffffffffffffffffffffffffffffffff1682602001516020015173ffffffffffffffffffffffffffffffffffffffff16145b15610924576004825f019060068111156107ba576107b96124e2565b5b908160068111156107ce576107cd6124e2565b5b81525050815f01518261014001515f019060068111156107f1576107f06124e2565b5b90816006811115610805576108046124e2565b5b81525050815f01518261016001515f01906006811115610828576108276124e2565b5b9081600681111561083c5761083b6124e2565b5b81525050815f01518261018001515f0190600681111561085f5761085e6124e2565b5b90816006811115610873576108726124e2565b5b81525050815f0151826101a001515f01906006811115610896576108956124e2565b5b908160068111156108aa576108a96124e2565b5b81525050815f0151826101c001515f019060068111156108cd576108cc6124e2565b5b908160068111156108e1576108e06124e2565b5b81525050815f0151826101e001515f01906006811115610904576109036124e2565b5b90816006811115610918576109176124e2565b5b815250508190506113ff565b5f826040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610972573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061099691906128f9565b90505f836060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa1580156109e6573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610a0a91906128f9565b90505f84602001515f015173ffffffffffffffffffffffffffffffffffffffff1663e6a43905866040015187606001516040518363ffffffff1660e01b8152600401610a57929190612933565b602060405180830381865afa158015610a72573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610a96919061296e565b90505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610d54576003855f01906006811115610ae357610ae26124e2565b5b90816006811115610af757610af66124e2565b5b81525050846040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610b48573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610b6c91906128f9565b856080019060ff16908160ff1681525050846060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610bca573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610bee91906128f9565b8560a0019060ff16908160ff1681525050845f01518561014001515f01906006811115610c1e57610c1d6124e2565b5b90816006811115610c3257610c316124e2565b5b81525050845f01518561016001515f01906006811115610c5557610c546124e2565b5b90816006811115610c6957610c686124e2565b5b81525050845f01518561018001515f01906006811115610c8c57610c8b6124e2565b5b90816006811115610ca057610c9f6124e2565b5b81525050845f0151856101a001515f01906006811115610cc357610cc26124e2565b5b90816006811115610cd757610cd66124e2565b5b81525050845f0151856101c001515f01906006811115610cfa57610cf96124e2565b5b90816006811115610d0e57610d0d6124e2565b5b81525050845f0151856101e001515f01906006811115610d3157610d306124e2565b5b90816006811115610d4557610d446124e2565b5b815250508493505050506113ff565b5f808273ffffffffffffffffffffffffffffffffffffffff16630902f1ac6040518163ffffffff1660e01b8152600401606060405180830381865afa158015610d9f573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610dc39190612a15565b50915091505f8373ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa158015610e12573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610e36919061296e565b90505f8473ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa158015610e82573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610ea6919061296e565b90508173ffffffffffffffffffffffffffffffffffffffff16896040015173ffffffffffffffffffffffffffffffffffffffff16148015610f1657508073ffffffffffffffffffffffffffffffffffffffff16896060015173ffffffffffffffffffffffffffffffffffffffff16145b1561118f575f895f01906006811115610f3257610f316124e2565b5b90816006811115610f4657610f456124e2565b5b81525050886040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610f97573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610fbb91906128f9565b896080019060ff16908160ff1681525050886060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015611019573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061103d91906128f9565b8960a0019060ff16908160ff168152505061106a846dffffffffffffffffffffffffffff16886012611485565b89610100018181525050611090836dffffffffffffffffffffffffffff16876012611485565b896101200181815250506110bc8960c001518a61010001518b61012001518c6020015160200151611c02565b8961014001819052506110e78960e001518a61012001518b61010001518c6020015160200151611c02565b8961016001819052506111128960c001518a61010001518b61012001518c6020015160200151611d5e565b89610180018190525061113d8960e001518a61012001518b61010001518c6020015160200151611d5e565b896101a0018190525061115a8961018001518a6101400151611ece565b896101c00181905250611177896101a001518a6101600151611ece565b896101e00181905250889750505050505050506113ff565b5f895f019060068111156111a6576111a56124e2565b5b908160068111156111ba576111b96124e2565b5b81525050886040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa15801561120b573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061122f91906128f9565b896080019060ff16908160ff1681525050886060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa15801561128d573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906112b191906128f9565b8960a0019060ff16908160ff16815250506112de836dffffffffffffffffffffffffffff16886012611485565b89610100018181525050611304846dffffffffffffffffffffffffffff16876012611485565b896101200181815250506113308960c001518a61010001518b61012001518c6020015160200151611c02565b89610140018190525061135b8960e001518a61012001518b61010001518c6020015160200151611c02565b8961016001819052506113868960c001518a61010001518b61012001518c6020015160200151611d5e565b8961018001819052506113b18960e001518a61012001518b61010001518c6020015160200151611d5e565b896101a001819052506113ce8961018001518a6101400151611ece565b896101c001819052506113eb896101a001518a6101600151611ece565b896101e00181905250889750505050505050505b919050565b5f61142161141284846115ad565b68056bc75e2d63100000611bba565b905092915050565b5f805f6114368585612024565b915091508161147a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161147190612ad5565b60405180910390fd5b809250505092915050565b5f600260ff168360ff161080156114a25750600260ff168260ff16105b156114e2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114d990612b63565b60405180910390fd5b601260ff168360ff161180156114fe5750601260ff168260ff16115b1561153e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161153590612bf1565b60405180910390fd5b5f84148061155157508160ff168360ff16145b61157d576115788483600a6115669190612d6b565b85600a6115739190612d6b565b61204a565b61157f565b835b90509392505050565b5f6115a561159f8468056bc75e2d631000006115ad565b83611bba565b905092915050565b5f6115c183670de0b6b3a76400008461204a565b905092915050565b5f6115d2612154565b825f01515f015181602001515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050825f01516020015181602001516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508260200151816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508260400151816060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505082606001518160c00181815250506116e58161065d565b90505f60068111156116fa576116f96124e2565b5b815f015160068111156117105761170f6124e2565b5b1461172157805f0151915050611bb5565b8260800151816101c00151602001511115611740576005915050611bb5565b5f6117cc826040015173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016117819190612db5565b602060405180830381865afa15801561179c573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906117c09190612de2565b83608001516012611485565b9050808260c0015111156117e557600692505050611bb5565b816040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b38360200151602001515f6040518363ffffffff1660e01b815260040161182c929190612e4f565b6020604051808303815f875af1158015611848573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061186c9190612eab565b50816040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b38360200151602001516118aa8560c0015160128760800151611485565b6040518363ffffffff1660e01b81526004016118c7929190612ed6565b6020604051808303815f875af11580156118e3573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906119079190612eab565b505f600267ffffffffffffffff81111561192457611923612efd565b5b6040519080825280602002602001820160405280156119525781602001602082028036833780820191505090505b5090508260400151815f8151811061196d5761196c612f2a565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508260600151816001815181106119c0576119bf612f2a565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250505f83602001516020015173ffffffffffffffffffffffffffffffffffffffff166338ed1739611a338660c0015160128860800151611485565b5f8530426040518663ffffffff1660e01b8152600401611a57959493929190612fff565b5f604051808303815f875af1158015611a72573d5f803e3d5ffd5b505050506040513d5f823e3d601f19601f82011682018060405250810190611a9a919061317a565b90505f8160018351611aac91906131c1565b81518110611abd57611abc612f2a565b5b602002602001015190505f611ad88287608001516012611485565b9050856040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b38760200151602001515f6040518363ffffffff1660e01b8152600401611b21929190612e4f565b6020604051808303815f875af1158015611b3d573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611b619190612eab565b507ffa2dda1cc1b86e41239702756b13effbc1a092b5c57e3ad320fbe4f3b13fe235886020015189604001518a6060015184604051611ba394939291906131f4565b60405180910390a15f96505050505050505b919050565b5f611bce8383670de0b6b3a764000061204a565b905092915050565b5f805f838501905084811015611bf2575f809250925050611bfb565b60018192509250505b9250929050565b611c0a612293565b611c12612293565b5f8603611c52576002815f01906006811115611c3157611c306124e2565b5b90816006811115611c4557611c446124e2565b5b8152505080915050611d56565b5f851480611c5f57505f84145b15611c9d576001815f01906006811115611c7c57611c7b6124e2565b5b90816006811115611c9057611c8f6124e2565b5b8152505080915050611d56565b5f815f01906006811115611cb457611cb36124e2565b5b90816006811115611cc857611cc76124e2565b5b815250508273ffffffffffffffffffffffffffffffffffffffff1663ad615dec8787876040518463ffffffff1660e01b8152600401611d0993929190613237565b602060405180830381865afa158015611d24573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611d489190612de2565b816020018181525050809150505b949350505050565b611d666122bd565b611d6e6122bd565b5f8603611db8576002815f01906006811115611d8d57611d8c6124e2565b5b90816006811115611da157611da06124e2565b5b815250505f81602001818152505080915050611ec6565b5f851480611dc557505f84145b15611e0d576001815f01906006811115611de257611de16124e2565b5b90816006811115611df657611df56124e2565b5b815250505f81602001818152505080915050611ec6565b5f815f01906006811115611e2457611e236124e2565b5b90816006811115611e3857611e376124e2565b5b815250508273ffffffffffffffffffffffffffffffffffffffff1663054d50d48787876040518463ffffffff1660e01b8152600401611e7993929190613237565b602060405180830381865afa158015611e94573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611eb89190612de2565b816020018181525050809150505b949350505050565b611ed66122e7565b611ede6122e7565b5f6006811115611ef157611ef06124e2565b5b835f01516006811115611f0757611f066124e2565b5b14611f4757825f0151815f01906006811115611f2657611f256124e2565b5b90816006811115611f3a57611f396124e2565b5b815250508091505061201e565b5f6006811115611f5a57611f596124e2565b5b845f01516006811115611f7057611f6f6124e2565b5b14611fb057835f0151815f01906006811115611f8f57611f8e6124e2565b5b90816006811115611fa357611fa26124e2565b5b815250508091505061201e565b826020015184602001511115611fcf5782602001518460200181815250505b5f815f01906006811115611fe657611fe56124e2565b5b90816006811115611ffa57611ff96124e2565b5b81525050612010846020015184602001516105a1565b816020018181525050809150505b92915050565b5f8083831115612039575f8091509150612043565b6001838503915091505b9250929050565b5f805f80198587098587029250828110838203039150505f8103612082578382816120785761207761326c565b5b049250505061214d565b8084116120c4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016120bb906132e3565b60405180910390fd5b5f8486880990508281118203915080830392505f60018619018616905080860495508084049350600181825f0304019050808302841793505f600287600302189050808702600203810290508087026002038102905080870260020381029050808702600203810290508087026002038102905080870260020381029050808502955050505050505b9392505050565b6040518061020001604052805f6006811115612173576121726124e2565b5b8152602001612180612311565b81526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f60ff1681526020015f60ff1681526020015f81526020015f81526020015f81526020015f81526020016121ef612293565b81526020016121fc612293565b81526020016122096122bd565b81526020016122166122bd565b81526020016122236122e7565b81526020016122306122e7565b81525090565b6040518060a00160405280612249612311565b81526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f81526020015f81525090565b60405180604001604052805f60068111156122b1576122b06124e2565b5b81526020015f81525090565b60405180604001604052805f60068111156122db576122da6124e2565b5b81526020015f81525090565b60405180604001604052805f6006811115612305576123046124e2565b5b81526020015f81525090565b60405180604001604052805f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681525090565b5f604051905090565b5f80fd5b5f80fd5b5f819050919050565b61237881612366565b8114612382575f80fd5b50565b5f813590506123938161236f565b92915050565b5f80604083850312156123af576123ae61235e565b5b5f6123bc85828601612385565b92505060206123cd85828601612385565b9150509250929050565b6123e081612366565b82525050565b5f6020820190506123f95f8301846123d7565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f612428826123ff565b9050919050565b6124388161241e565b8114612442575f80fd5b50565b5f813590506124538161242f565b92915050565b5f805f805f8060c087890312156124735761247261235e565b5b5f61248089828a01612445565b965050602061249189828a01612445565b95505060406124a289828a01612445565b94505060606124b389828a01612445565b93505060806124c489828a01612385565b92505060a06124d589828a01612385565b9150509295509295509295565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffd5b600781106125205761251f6124e2565b5b50565b5f8190506125308261250f565b919050565b5f61253f82612523565b9050919050565b61254f81612535565b82525050565b61255e8161241e565b82525050565b604082015f8201516125785f850182612555565b50602082015161258b6020850182612555565b50505050565b5f60ff82169050919050565b6125a681612591565b82525050565b6125b581612366565b82525050565b604082015f8201516125cf5f850182612546565b5060208201516125e260208501826125ac565b50505050565b604082015f8201516125fc5f850182612546565b50602082015161260f60208501826125ac565b50505050565b604082015f8201516126295f850182612546565b50602082015161263c60208501826125ac565b50505050565b6102e082015f8201516126575f850182612546565b50602082015161266a6020850182612564565b50604082015161267d6060850182612555565b5060608201516126906080850182612555565b5060808201516126a360a085018261259d565b5060a08201516126b660c085018261259d565b5060c08201516126c960e08501826125ac565b5060e08201516126dd6101008501826125ac565b506101008201516126f26101208501826125ac565b506101208201516127076101408501826125ac565b5061014082015161271c6101608501826125bb565b506101608201516127316101a08501826125bb565b506101808201516127466101e08501826125e8565b506101a082015161275b6102208501826125e8565b506101c0820151612770610260850182612615565b506101e08201516127856102a0850182612615565b50505050565b5f6102e08201905061279f5f830184612642565b92915050565b6127ae81612591565b81146127b8575f80fd5b50565b5f813590506127c9816127a5565b92915050565b5f805f606084860312156127e6576127e561235e565b5b5f6127f386828701612385565b9350506020612804868287016127bb565b9250506040612815868287016127bb565b9150509250925092565b61282881612535565b82525050565b5f6020820190506128415f83018461281f565b92915050565b5f82825260208201905092915050565b7f4669786564506f696e74456e67696e653a2061726974686d65746963206f76655f8201527f72666c6f77000000000000000000000000000000000000000000000000000000602082015250565b5f6128b1602583612847565b91506128bc82612857565b604082019050919050565b5f6020820190508181035f8301526128de816128a5565b9050919050565b5f815190506128f3816127a5565b92915050565b5f6020828403121561290e5761290d61235e565b5b5f61291b848285016128e5565b91505092915050565b61292d8161241e565b82525050565b5f6040820190506129465f830185612924565b6129536020830184612924565b9392505050565b5f815190506129688161242f565b92915050565b5f602082840312156129835761298261235e565b5b5f6129908482850161295a565b91505092915050565b5f6dffffffffffffffffffffffffffff82169050919050565b6129bb81612999565b81146129c5575f80fd5b50565b5f815190506129d6816129b2565b92915050565b5f63ffffffff82169050919050565b6129f4816129dc565b81146129fe575f80fd5b50565b5f81519050612a0f816129eb565b92915050565b5f805f60608486031215612a2c57612a2b61235e565b5b5f612a39868287016129c8565b9350506020612a4a868287016129c8565b9250506040612a5b86828701612a01565b9150509250925092565b7f4669786564506f696e74456e67696e653a2061726974686d6574696320756e645f8201527f6572666c6f770000000000000000000000000000000000000000000000000000602082015250565b5f612abf602683612847565b9150612aca82612a65565b604082019050919050565b5f6020820190508181035f830152612aec81612ab3565b9050919050565b7f4669786564506f696e74456e67696e653a2060646563696d616c7360203c20605f8201527f5f4d494e5f444543494d414c5360000000000000000000000000000000000000602082015250565b5f612b4d602e83612847565b9150612b5882612af3565b604082019050919050565b5f6020820190508181035f830152612b7a81612b41565b9050919050565b7f4669786564506f696e74456e67696e653a2060646563696d616c7360203e20605f8201527f5f4d41585f444543494d414c5360000000000000000000000000000000000000602082015250565b5f612bdb602e83612847565b9150612be682612b81565b604082019050919050565b5f6020820190508181035f830152612c0881612bcf565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f8160011c9050919050565b5f808291508390505b6001851115612c9157808604811115612c6d57612c6c612c0f565b5b6001851615612c7c5780820291505b8081029050612c8a85612c3c565b9450612c51565b94509492505050565b5f82612ca95760019050612d64565b81612cb6575f9050612d64565b8160018114612ccc5760028114612cd657612d05565b6001915050612d64565b60ff841115612ce857612ce7612c0f565b5b8360020a915084821115612cff57612cfe612c0f565b5b50612d64565b5060208310610133831016604e8410600b8410161715612d3a5782820a905083811115612d3557612d34612c0f565b5b612d64565b612d478484846001612c48565b92509050818404811115612d5e57612d5d612c0f565b5b81810290505b9392505050565b5f612d7582612366565b9150612d8083612591565b9250612dad7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484612c9a565b905092915050565b5f602082019050612dc85f830184612924565b92915050565b5f81519050612ddc8161236f565b92915050565b5f60208284031215612df757612df661235e565b5b5f612e0484828501612dce565b91505092915050565b5f819050919050565b5f819050919050565b5f612e39612e34612e2f84612e0d565b612e16565b612366565b9050919050565b612e4981612e1f565b82525050565b5f604082019050612e625f830185612924565b612e6f6020830184612e40565b9392505050565b5f8115159050919050565b612e8a81612e76565b8114612e94575f80fd5b50565b5f81519050612ea581612e81565b92915050565b5f60208284031215612ec057612ebf61235e565b5b5f612ecd84828501612e97565b91505092915050565b5f604082019050612ee95f830185612924565b612ef660208301846123d7565b9392505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f612f8b8383612555565b60208301905092915050565b5f602082019050919050565b5f612fad82612f57565b612fb78185612f61565b9350612fc283612f71565b805f5b83811015612ff2578151612fd98882612f80565b9750612fe483612f97565b925050600181019050612fc5565b5085935050505092915050565b5f60a0820190506130125f8301886123d7565b61301f6020830187612e40565b81810360408301526130318186612fa3565b90506130406060830185612924565b61304d60808301846123d7565b9695505050505050565b5f80fd5b5f601f19601f8301169050919050565b6130748261305b565b810181811067ffffffffffffffff8211171561309357613092612efd565b5b80604052505050565b5f6130a5612355565b90506130b1828261306b565b919050565b5f67ffffffffffffffff8211156130d0576130cf612efd565b5b602082029050602081019050919050565b5f80fd5b5f6130f76130f2846130b6565b61309c565b9050808382526020820190506020840283018581111561311a576131196130e1565b5b835b81811015613143578061312f8882612dce565b84526020840193505060208101905061311c565b5050509392505050565b5f82601f83011261316157613160613057565b5b81516131718482602086016130e5565b91505092915050565b5f6020828403121561318f5761318e61235e565b5b5f82015167ffffffffffffffff8111156131ac576131ab612362565b5b6131b88482850161314d565b91505092915050565b5f6131cb82612366565b91506131d683612366565b92508282039050818111156131ee576131ed612c0f565b5b92915050565b5f6080820190506132075f830187612924565b6132146020830186612924565b61322160408301856123d7565b61322e60608301846123d7565b95945050505050565b5f60608201905061324a5f8301866123d7565b61325760208301856123d7565b61326460408301846123d7565b949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b7f4d6174683a206d756c446976206f766572666c6f7700000000000000000000005f82015250565b5f6132cd601583612847565b91506132d882613299565b602082019050919050565b5f6020820190508181035f8301526132fa816132c1565b905091905056fea2646970667358221220c5bcda1937e72f3e553e3b288e407d2637f381ac4cd60b41bdecd4cca317921a64736f6c634300081a0033"
        )).unwrap()!;

        let r = (await machine.query({
            to: uniswapEngine,
            methodSignature: "function debug__pair(address,address,address,address,uint256,uint256) external view returns (uint8,(address,address),address,address,uint8,uint8,uint256,uint256,uint256,uint256,(uint8,uint256),(uint8,uint256),(uint8,uint256),(uint8,uint256),(uint8,uint256),(uint8,uint256))",
            methodName: "debug__pair",
            methodArgs: [
                factory,
                router,
                wmatic,
                usdc,
                BigInt(3 * 10**18),
                BigInt(1 * 10**18)
            ]
        })).unwrap() as any;
        log(Number(r[10][1]) / 10**18);


        let engine = (await deploy(
            "RebalanceEngine",
            "6080604052348015600e575f80fd5b50613eea8061001c5f395ff3fe608060405234801561000f575f80fd5b50600436106100b2575f3560e01c80634ca69fcc1161006f5780634ca69fcc146101d6578063540e72c31461020657806355b865421461023657806379849f1f14610266578063b718a0b014610296578063c6ddba5e146102c6576100b2565b8063109acad7146100b65780631cab9c4f146100e6578063245ad5411461011657806330df7026146101465780633ee37280146101765780634c8d0af1146101a6575b5f80fd5b6100d060048036038101906100cb9190612dba565b6102f6565b6040516100dd9190612e07565b60405180910390f35b61010060048036038101906100fb9190612dba565b610309565b60405161010d9190612e07565b60405180910390f35b610130600480360381019061012b9190612dba565b61031c565b60405161013d9190612e07565b60405180910390f35b610160600480360381019061015b9190612e7a565b61032f565b60405161016d91906131ac565b60405180910390f35b610190600480360381019061018b9190612dba565b610450565b60405161019d9190612e07565b60405180910390f35b6101c060048036038101906101bb9190612dba565b610463565b6040516101cd9190612e07565b60405180910390f35b6101f060048036038101906101eb91906131f0565b610476565b6040516101fd9190612e07565b60405180910390f35b610220600480360381019061021b9190613240565b61048b565b60405161022d91906133b8565b60405180910390f35b610250600480360381019061024b9190612dba565b610596565b60405161025d9190612e07565b60405180910390f35b610280600480360381019061027b9190612dba565b6105a9565b60405161028d9190612e07565b60405180910390f35b6102b060048036038101906102ab9190612e7a565b6105bc565b6040516102bd91906133e1565b60405180910390f35b6102e060048036038101906102db9190612dba565b6106d4565b6040516102ed9190612e07565b60405180910390f35b5f61030183836106e7565b905092915050565b5f610314838361070c565b905092915050565b5f6103278383610747565b905092915050565b610337612abc565b61033f612abc565b8781602001515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508681602001516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505085816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505084816060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050838160c0018181525050828160e0018181525050610443816107a3565b9150509695505050505050565b5f61045b838361154a565b905092915050565b5f61046e838361156f565b905092915050565b5f6104828484846115cb565b90509392505050565b610493612b9e565b61049b612b9e565b8581602001515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508481602001516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505083816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505082816060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505061058b816116ce565b915050949350505050565b5f6105a18383611ef0565b905092915050565b5f6105b48383611f15565b905092915050565b5f6105c5612c2d565b87815f01515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505086815f01516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505085816020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505084816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505083816060018181525050828160800181815250506106c781611f31565b9150509695505050505050565b5f6106df8383612522565b905092915050565b5f61070468056bc75e2d631000006106ff858561070c565b61156f565b905092915050565b5f80830361071c575f9050610741565b818310156107335761072e838361154a565b61073e565b68056bc75e2d631000005b90505b92915050565b5f805f610754858561253e565b9150915081610798576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161078f9061347a565b60405180910390fd5b809250505092915050565b6107ab612abc565b5f8260c00151146107c0578160c001516107ca565b670de0b6b3a76400005b8260c00181815250505f8260e00151146107e8578160e001516107f2565b670de0b6b3a76400005b8260e00181815250505f73ffffffffffffffffffffffffffffffffffffffff16826040015173ffffffffffffffffffffffffffffffffffffffff16148061086857505f73ffffffffffffffffffffffffffffffffffffffff16826060015173ffffffffffffffffffffffffffffffffffffffff16145b806108a557505f73ffffffffffffffffffffffffffffffffffffffff1682602001515f015173ffffffffffffffffffffffffffffffffffffffff16145b806108e357505f73ffffffffffffffffffffffffffffffffffffffff1682602001516020015173ffffffffffffffffffffffffffffffffffffffff16145b15610a6a576004825f01906006811115610900576108ff612f03565b5b9081600681111561091457610913612f03565b5b81525050815f01518261014001515f0190600681111561093757610936612f03565b5b9081600681111561094b5761094a612f03565b5b81525050815f01518261016001515f0190600681111561096e5761096d612f03565b5b9081600681111561098257610981612f03565b5b81525050815f01518261018001515f019060068111156109a5576109a4612f03565b5b908160068111156109b9576109b8612f03565b5b81525050815f0151826101a001515f019060068111156109dc576109db612f03565b5b908160068111156109f0576109ef612f03565b5b81525050815f0151826101c001515f01906006811115610a1357610a12612f03565b5b90816006811115610a2757610a26612f03565b5b81525050815f0151826101e001515f01906006811115610a4a57610a49612f03565b5b90816006811115610a5e57610a5d612f03565b5b81525050819050611545565b5f826040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610ab8573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610adc91906134ac565b90505f836060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610b2c573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610b5091906134ac565b90505f84602001515f015173ffffffffffffffffffffffffffffffffffffffff1663e6a43905866040015187606001516040518363ffffffff1660e01b8152600401610b9d9291906134e6565b602060405180830381865afa158015610bb8573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610bdc9190613521565b90505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610e9a576003855f01906006811115610c2957610c28612f03565b5b90816006811115610c3d57610c3c612f03565b5b81525050846040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610c8e573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610cb291906134ac565b856080019060ff16908160ff1681525050846060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015610d10573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610d3491906134ac565b8560a0019060ff16908160ff1681525050845f01518561014001515f01906006811115610d6457610d63612f03565b5b90816006811115610d7857610d77612f03565b5b81525050845f01518561016001515f01906006811115610d9b57610d9a612f03565b5b90816006811115610daf57610dae612f03565b5b81525050845f01518561018001515f01906006811115610dd257610dd1612f03565b5b90816006811115610de657610de5612f03565b5b81525050845f0151856101a001515f01906006811115610e0957610e08612f03565b5b90816006811115610e1d57610e1c612f03565b5b81525050845f0151856101c001515f01906006811115610e4057610e3f612f03565b5b90816006811115610e5457610e53612f03565b5b81525050845f0151856101e001515f01906006811115610e7757610e76612f03565b5b90816006811115610e8b57610e8a612f03565b5b81525050849350505050611545565b5f808273ffffffffffffffffffffffffffffffffffffffff16630902f1ac6040518163ffffffff1660e01b8152600401606060405180830381865afa158015610ee5573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610f0991906135c8565b50915091505f8373ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa158015610f58573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610f7c9190613521565b90505f8473ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa158015610fc8573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610fec9190613521565b90508173ffffffffffffffffffffffffffffffffffffffff16896040015173ffffffffffffffffffffffffffffffffffffffff1614801561105c57508073ffffffffffffffffffffffffffffffffffffffff16896060015173ffffffffffffffffffffffffffffffffffffffff16145b156112d5575f895f0190600681111561107857611077612f03565b5b9081600681111561108c5761108b612f03565b5b81525050886040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa1580156110dd573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061110191906134ac565b896080019060ff16908160ff1681525050886060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa15801561115f573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061118391906134ac565b8960a0019060ff16908160ff16815250506111b0846dffffffffffffffffffffffffffff168860126115cb565b896101000181815250506111d6836dffffffffffffffffffffffffffff168760126115cb565b896101200181815250506112028960c001518a61010001518b61012001518c602001516020015161256a565b89610140018190525061122d8960e001518a61012001518b61010001518c602001516020015161256a565b8961016001819052506112588960c001518a61010001518b61012001518c60200151602001516126c6565b8961018001819052506112838960e001518a61012001518b61010001518c60200151602001516126c6565b896101a001819052506112a08961018001518a6101400151612836565b896101c001819052506112bd896101a001518a6101600151612836565b896101e0018190525088975050505050505050611545565b5f895f019060068111156112ec576112eb612f03565b5b90816006811115611300576112ff612f03565b5b81525050886040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015611351573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061137591906134ac565b896080019060ff16908160ff1681525050886060015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa1580156113d3573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906113f791906134ac565b8960a0019060ff16908160ff1681525050611424836dffffffffffffffffffffffffffff168860126115cb565b8961010001818152505061144a846dffffffffffffffffffffffffffff168760126115cb565b896101200181815250506114768960c001518a61010001518b61012001518c602001516020015161256a565b8961014001819052506114a18960e001518a61012001518b61010001518c602001516020015161256a565b8961016001819052506114cc8960c001518a61010001518b61012001518c60200151602001516126c6565b8961018001819052506114f78960e001518a61012001518b61010001518c60200151602001516126c6565b896101a001819052506115148961018001518a6101400151612836565b896101c00181905250611531896101a001518a6101600151612836565b896101e00181905250889750505050505050505b919050565b5f6115676115588484611f15565b68056bc75e2d63100000612522565b905092915050565b5f805f61157c858561298c565b91509150816115c0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016115b790613688565b60405180910390fd5b809250505092915050565b5f600260ff168360ff161080156115e85750600260ff168260ff16105b15611628576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161161f90613716565b60405180910390fd5b601260ff168360ff161180156116445750601260ff168260ff16115b15611684576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161167b906137a4565b60405180910390fd5b5f84148061169757508160ff168360ff16145b6116c3576116be8483600a6116ac919061391e565b85600a6116b9919061391e565b6129b2565b6116c5565b835b90509392505050565b6116d6612b9e565b5f73ffffffffffffffffffffffffffffffffffffffff16826040015173ffffffffffffffffffffffffffffffffffffffff16148061174357505f73ffffffffffffffffffffffffffffffffffffffff16826060015173ffffffffffffffffffffffffffffffffffffffff16145b8061178057505f73ffffffffffffffffffffffffffffffffffffffff1682602001515f015173ffffffffffffffffffffffffffffffffffffffff16145b806117be57505f73ffffffffffffffffffffffffffffffffffffffff1682602001516020015173ffffffffffffffffffffffffffffffffffffffff16145b156117fb576004825f019060078111156117db576117da612f03565b5b908160078111156117ef576117ee612f03565b5b81525050819050611eeb565b611803612abc565b82602001515f015181602001515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505082602001516020015181602001516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508260400151816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508260600151816060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250506119f8816040015173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016119419190613968565b602060405180830381865afa15801561195c573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906119809190613995565b826040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa1580156119cd573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906119f191906134ac565b60126115cb565b8160c0018181525050611a0a816107a3565b90505f6006811115611a1f57611a1e612f03565b5b815f01516006811115611a3557611a34612f03565b5b14611bbc5760016006811115611a4e57611a4d612f03565b5b815f01516006811115611a6457611a63612f03565b5b14611b825760026006811115611a7d57611a7c612f03565b5b815f01516006811115611a9357611a92612f03565b5b14611b7a5760036006811115611aac57611aab612f03565b5b815f01516006811115611ac257611ac1612f03565b5b14611b725760046006811115611adb57611ada612f03565b5b815f01516006811115611af157611af0612f03565b5b14611b6a5760056006811115611b0a57611b09612f03565b5b815f01516006811115611b2057611b1f612f03565b5b14611b6257600680811115611b3857611b37612f03565b5b815f01516006811115611b4e57611b4d612f03565b5b14611b5a576007611b5d565b60065b611b65565b60055b611b6d565b60045b611b75565b60035b611b7d565b60025b611b85565b60015b835f01906007811115611b9b57611b9a612f03565b5b90816007811115611baf57611bae612f03565b5b8152505082915050611eeb565b611cb3816040015173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b8152600401611bfc9190613968565b602060405180830381865afa158015611c17573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611c3b9190613995565b826040015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015611c88573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611cac91906134ac565b60126115cb565b8360800181815250505f6006811115611ccf57611cce612f03565b5b8161014001515f01516006811115611cea57611ce9612f03565b5b14611e5d5760016006811115611d0357611d02612f03565b5b8161014001515f01516006811115611d1e57611d1d612f03565b5b14611e555760026006811115611d3757611d36612f03565b5b8161014001515f01516006811115611d5257611d51612f03565b5b14611e4d5760036006811115611d6b57611d6a612f03565b5b8161014001515f01516006811115611d8657611d85612f03565b5b14611e455760046006811115611d9f57611d9e612f03565b5b8161014001515f01516006811115611dba57611db9612f03565b5b14611e3d5760056006811115611dd357611dd2612f03565b5b8161014001515f01516006811115611dee57611ded612f03565b5b14611e3557600680811115611e0657611e05612f03565b5b8161014001515f01516006811115611e2157611e20612f03565b5b14611e2d576007611e30565b60065b611e38565b60055b611e40565b60045b611e48565b60035b611e50565b60025b611e58565b60015b611e5f565b5f5b8360e001515f01906007811115611e7957611e78612f03565b5b90816007811115611e8d57611e8c612f03565b5b815250505f836080015114611eab5780610140015160200151611ead565b5f5b8360e00151602001818152505080608001518360a0019060ff16908160ff16815250508060a001518360c0019060ff16908160ff1681525050829150505b919050565b5f611f0d611f078468056bc75e2d63100000611f15565b83612522565b905092915050565b5f611f2983670de0b6b3a7640000846129b2565b905092915050565b5f611f3a612abc565b825f01515f015181602001515f019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050825f01516020015181602001516020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508260200151816040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508260400151816060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505082606001518160c001818152505061204d816107a3565b90505f600681111561206257612061612f03565b5b815f0151600681111561207857612077612f03565b5b1461208957805f015191505061251d565b8260800151816101c001516020015111156120a857600591505061251d565b5f612134826040015173ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016120e99190613968565b602060405180830381865afa158015612104573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906121289190613995565b836080015160126115cb565b9050808260c00151111561214d5760069250505061251d565b816040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b38360200151602001515f6040518363ffffffff1660e01b8152600401612194929190613a02565b6020604051808303815f875af11580156121b0573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906121d49190613a5e565b50816040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b38360200151602001516122128560c00151601287608001516115cb565b6040518363ffffffff1660e01b815260040161222f929190613a89565b6020604051808303815f875af115801561224b573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061226f9190613a5e565b505f600267ffffffffffffffff81111561228c5761228b613ab0565b5b6040519080825280602002602001820160405280156122ba5781602001602082028036833780820191505090505b5090508260400151815f815181106122d5576122d4613add565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505082606001518160018151811061232857612327613add565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250505f83602001516020015173ffffffffffffffffffffffffffffffffffffffff166338ed173961239b8660c00151601288608001516115cb565b5f8530426040518663ffffffff1660e01b81526004016123bf959493929190613bb2565b5f604051808303815f875af11580156123da573d5f803e3d5ffd5b505050506040513d5f823e3d601f19601f820116820180604052508101906124029190613d2d565b90505f81600183516124149190613d74565b8151811061242557612424613add565b5b602002602001015190505f61244082876080015160126115cb565b9050856040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b38760200151602001515f6040518363ffffffff1660e01b8152600401612489929190613a02565b6020604051808303815f875af11580156124a5573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906124c99190613a5e565b507ffa2dda1cc1b86e41239702756b13effbc1a092b5c57e3ad320fbe4f3b13fe235886020015189604001518a606001518460405161250b9493929190613da7565b60405180910390a15f96505050505050505b919050565b5f6125368383670de0b6b3a76400006129b2565b905092915050565b5f805f83850190508481101561255a575f809250925050612563565b60018192509250505b9250929050565b612572612c8a565b61257a612c8a565b5f86036125ba576002815f0190600681111561259957612598612f03565b5b908160068111156125ad576125ac612f03565b5b81525050809150506126be565b5f8514806125c757505f84145b15612605576001815f019060068111156125e4576125e3612f03565b5b908160068111156125f8576125f7612f03565b5b81525050809150506126be565b5f815f0190600681111561261c5761261b612f03565b5b908160068111156126305761262f612f03565b5b815250508273ffffffffffffffffffffffffffffffffffffffff1663ad615dec8787876040518463ffffffff1660e01b815260040161267193929190613dea565b602060405180830381865afa15801561268c573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906126b09190613995565b816020018181525050809150505b949350505050565b6126ce612cb4565b6126d6612cb4565b5f8603612720576002815f019060068111156126f5576126f4612f03565b5b9081600681111561270957612708612f03565b5b815250505f8160200181815250508091505061282e565b5f85148061272d57505f84145b15612775576001815f0190600681111561274a57612749612f03565b5b9081600681111561275e5761275d612f03565b5b815250505f8160200181815250508091505061282e565b5f815f0190600681111561278c5761278b612f03565b5b908160068111156127a05761279f612f03565b5b815250508273ffffffffffffffffffffffffffffffffffffffff1663054d50d48787876040518463ffffffff1660e01b81526004016127e193929190613dea565b602060405180830381865afa1580156127fc573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906128209190613995565b816020018181525050809150505b949350505050565b61283e612cde565b612846612cde565b5f600681111561285957612858612f03565b5b835f0151600681111561286f5761286e612f03565b5b146128af57825f0151815f0190600681111561288e5761288d612f03565b5b908160068111156128a2576128a1612f03565b5b8152505080915050612986565b5f60068111156128c2576128c1612f03565b5b845f015160068111156128d8576128d7612f03565b5b1461291857835f0151815f019060068111156128f7576128f6612f03565b5b9081600681111561290b5761290a612f03565b5b8152505080915050612986565b8260200151846020015111156129375782602001518460200181815250505b5f815f0190600681111561294e5761294d612f03565b5b9081600681111561296257612961612f03565b5b81525050612978846020015184602001516106e7565b816020018181525050809150505b92915050565b5f80838311156129a1575f80915091506129ab565b6001838503915091505b9250929050565b5f805f80198587098587029250828110838203039150505f81036129ea578382816129e0576129df613e1f565b5b0492505050612ab5565b808411612a2c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612a2390613e96565b60405180910390fd5b5f8486880990508281118203915080830392505f60018619018616905080860495508084049350600181825f0304019050808302841793505f600287600302189050808702600203810290508087026002038102905080870260020381029050808702600203810290508087026002038102905080870260020381029050808502955050505050505b9392505050565b6040518061020001604052805f6006811115612adb57612ada612f03565b5b8152602001612ae8612d08565b81526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f60ff1681526020015f60ff1681526020015f81526020015f81526020015f81526020015f8152602001612b57612c8a565b8152602001612b64612c8a565b8152602001612b71612cb4565b8152602001612b7e612cb4565b8152602001612b8b612cde565b8152602001612b98612cde565b81525090565b6040518061010001604052805f6007811115612bbd57612bbc612f03565b5b8152602001612bca612d08565b81526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f81526020015f60ff1681526020015f60ff168152602001612c27612d4c565b81525090565b6040518060a00160405280612c40612d08565b81526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f81526020015f81525090565b60405180604001604052805f6006811115612ca857612ca7612f03565b5b81526020015f81525090565b60405180604001604052805f6006811115612cd257612cd1612f03565b5b81526020015f81525090565b60405180604001604052805f6006811115612cfc57612cfb612f03565b5b81526020015f81525090565b60405180604001604052805f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681525090565b60405180604001604052805f6007811115612d6a57612d69612f03565b5b81526020015f81525090565b5f604051905090565b5f80fd5b5f80fd5b5f819050919050565b612d9981612d87565b8114612da3575f80fd5b50565b5f81359050612db481612d90565b92915050565b5f8060408385031215612dd057612dcf612d7f565b5b5f612ddd85828601612da6565b9250506020612dee85828601612da6565b9150509250929050565b612e0181612d87565b82525050565b5f602082019050612e1a5f830184612df8565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f612e4982612e20565b9050919050565b612e5981612e3f565b8114612e63575f80fd5b50565b5f81359050612e7481612e50565b92915050565b5f805f805f8060c08789031215612e9457612e93612d7f565b5b5f612ea189828a01612e66565b9650506020612eb289828a01612e66565b9550506040612ec389828a01612e66565b9450506060612ed489828a01612e66565b9350506080612ee589828a01612da6565b92505060a0612ef689828a01612da6565b9150509295509295509295565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffd5b60078110612f4157612f40612f03565b5b50565b5f819050612f5182612f30565b919050565b5f612f6082612f44565b9050919050565b612f7081612f56565b82525050565b612f7f81612e3f565b82525050565b604082015f820151612f995f850182612f76565b506020820151612fac6020850182612f76565b50505050565b5f60ff82169050919050565b612fc781612fb2565b82525050565b612fd681612d87565b82525050565b604082015f820151612ff05f850182612f67565b5060208201516130036020850182612fcd565b50505050565b604082015f82015161301d5f850182612f67565b5060208201516130306020850182612fcd565b50505050565b604082015f82015161304a5f850182612f67565b50602082015161305d6020850182612fcd565b50505050565b6102e082015f8201516130785f850182612f67565b50602082015161308b6020850182612f85565b50604082015161309e6060850182612f76565b5060608201516130b16080850182612f76565b5060808201516130c460a0850182612fbe565b5060a08201516130d760c0850182612fbe565b5060c08201516130ea60e0850182612fcd565b5060e08201516130fe610100850182612fcd565b50610100820151613113610120850182612fcd565b50610120820151613128610140850182612fcd565b5061014082015161313d610160850182612fdc565b506101608201516131526101a0850182612fdc565b506101808201516131676101e0850182613009565b506101a082015161317c610220850182613009565b506101c0820151613191610260850182613036565b506101e08201516131a66102a0850182613036565b50505050565b5f6102e0820190506131c05f830184613063565b92915050565b6131cf81612fb2565b81146131d9575f80fd5b50565b5f813590506131ea816131c6565b92915050565b5f805f6060848603121561320757613206612d7f565b5b5f61321486828701612da6565b9350506020613225868287016131dc565b9250506040613236868287016131dc565b9150509250925092565b5f805f806080858703121561325857613257612d7f565b5b5f61326587828801612e66565b945050602061327687828801612e66565b935050604061328787828801612e66565b925050606061329887828801612e66565b91505092959194509250565b600881106132b5576132b4612f03565b5b50565b5f8190506132c5826132a4565b919050565b5f6132d4826132b8565b9050919050565b6132e4816132ca565b82525050565b604082015f8201516132fe5f8501826132db565b5060208201516133116020850182612fcd565b50505050565b61014082015f82015161332c5f8501826132db565b50602082015161333f6020850182612f85565b5060408201516133526060850182612f76565b5060608201516133656080850182612f76565b50608082015161337860a0850182612fcd565b5060a082015161338b60c0850182612fbe565b5060c082015161339e60e0850182612fbe565b5060e08201516133b26101008501826132ea565b50505050565b5f610140820190506133cc5f830184613317565b92915050565b6133db81612f56565b82525050565b5f6020820190506133f45f8301846133d2565b92915050565b5f82825260208201905092915050565b7f4669786564506f696e74456e67696e653a2061726974686d65746963206f76655f8201527f72666c6f77000000000000000000000000000000000000000000000000000000602082015250565b5f6134646025836133fa565b915061346f8261340a565b604082019050919050565b5f6020820190508181035f83015261349181613458565b9050919050565b5f815190506134a6816131c6565b92915050565b5f602082840312156134c1576134c0612d7f565b5b5f6134ce84828501613498565b91505092915050565b6134e081612e3f565b82525050565b5f6040820190506134f95f8301856134d7565b61350660208301846134d7565b9392505050565b5f8151905061351b81612e50565b92915050565b5f6020828403121561353657613535612d7f565b5b5f6135438482850161350d565b91505092915050565b5f6dffffffffffffffffffffffffffff82169050919050565b61356e8161354c565b8114613578575f80fd5b50565b5f8151905061358981613565565b92915050565b5f63ffffffff82169050919050565b6135a78161358f565b81146135b1575f80fd5b50565b5f815190506135c28161359e565b92915050565b5f805f606084860312156135df576135de612d7f565b5b5f6135ec8682870161357b565b93505060206135fd8682870161357b565b925050604061360e868287016135b4565b9150509250925092565b7f4669786564506f696e74456e67696e653a2061726974686d6574696320756e645f8201527f6572666c6f770000000000000000000000000000000000000000000000000000602082015250565b5f6136726026836133fa565b915061367d82613618565b604082019050919050565b5f6020820190508181035f83015261369f81613666565b9050919050565b7f4669786564506f696e74456e67696e653a2060646563696d616c7360203c20605f8201527f5f4d494e5f444543494d414c5360000000000000000000000000000000000000602082015250565b5f613700602e836133fa565b915061370b826136a6565b604082019050919050565b5f6020820190508181035f83015261372d816136f4565b9050919050565b7f4669786564506f696e74456e67696e653a2060646563696d616c7360203e20605f8201527f5f4d41585f444543494d414c5360000000000000000000000000000000000000602082015250565b5f61378e602e836133fa565b915061379982613734565b604082019050919050565b5f6020820190508181035f8301526137bb81613782565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f8160011c9050919050565b5f808291508390505b6001851115613844578086048111156138205761381f6137c2565b5b600185161561382f5780820291505b808102905061383d856137ef565b9450613804565b94509492505050565b5f8261385c5760019050613917565b81613869575f9050613917565b816001811461387f5760028114613889576138b8565b6001915050613917565b60ff84111561389b5761389a6137c2565b5b8360020a9150848211156138b2576138b16137c2565b5b50613917565b5060208310610133831016604e8410600b84101617156138ed5782820a9050838111156138e8576138e76137c2565b5b613917565b6138fa84848460016137fb565b92509050818404811115613911576139106137c2565b5b81810290505b9392505050565b5f61392882612d87565b915061393383612fb2565b92506139607fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848461384d565b905092915050565b5f60208201905061397b5f8301846134d7565b92915050565b5f8151905061398f81612d90565b92915050565b5f602082840312156139aa576139a9612d7f565b5b5f6139b784828501613981565b91505092915050565b5f819050919050565b5f819050919050565b5f6139ec6139e76139e2846139c0565b6139c9565b612d87565b9050919050565b6139fc816139d2565b82525050565b5f604082019050613a155f8301856134d7565b613a2260208301846139f3565b9392505050565b5f8115159050919050565b613a3d81613a29565b8114613a47575f80fd5b50565b5f81519050613a5881613a34565b92915050565b5f60208284031215613a7357613a72612d7f565b5b5f613a8084828501613a4a565b91505092915050565b5f604082019050613a9c5f8301856134d7565b613aa96020830184612df8565b9392505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f613b3e8383612f76565b60208301905092915050565b5f602082019050919050565b5f613b6082613b0a565b613b6a8185613b14565b9350613b7583613b24565b805f5b83811015613ba5578151613b8c8882613b33565b9750613b9783613b4a565b925050600181019050613b78565b5085935050505092915050565b5f60a082019050613bc55f830188612df8565b613bd260208301876139f3565b8181036040830152613be48186613b56565b9050613bf360608301856134d7565b613c006080830184612df8565b9695505050505050565b5f80fd5b5f601f19601f8301169050919050565b613c2782613c0e565b810181811067ffffffffffffffff82111715613c4657613c45613ab0565b5b80604052505050565b5f613c58612d76565b9050613c648282613c1e565b919050565b5f67ffffffffffffffff821115613c8357613c82613ab0565b5b602082029050602081019050919050565b5f80fd5b5f613caa613ca584613c69565b613c4f565b90508083825260208201905060208402830185811115613ccd57613ccc613c94565b5b835b81811015613cf65780613ce28882613981565b845260208401935050602081019050613ccf565b5050509392505050565b5f82601f830112613d1457613d13613c0a565b5b8151613d24848260208601613c98565b91505092915050565b5f60208284031215613d4257613d41612d7f565b5b5f82015167ffffffffffffffff811115613d5f57613d5e612d83565b5b613d6b84828501613d00565b91505092915050565b5f613d7e82612d87565b9150613d8983612d87565b9250828203905081811115613da157613da06137c2565b5b92915050565b5f608082019050613dba5f8301876134d7565b613dc760208301866134d7565b613dd46040830185612df8565b613de16060830184612df8565b95945050505050565b5f606082019050613dfd5f830186612df8565b613e0a6020830185612df8565b613e176040830184612df8565b949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b7f4d6174683a206d756c446976206f766572666c6f7700000000000000000000005f82015250565b5f613e806015836133fa565b9150613e8b82613e4c565b602082019050919050565b5f6020820190508181035f830152613ead81613e74565b905091905056fea26469706673582212209c613bdce8044c79b99b8ee171e93d261e040d83f83ca69d784d61b7db63c4f564736f6c634300081a0033",
        )).unwrap()!;


        //log(await fetch());
        log(await balance());
        log(await totalValue());
        await transfer(400);
        log(await balance());
        log(await totalValue());
        await transfer(8000);
        log(await balance());
        log(await totalValue());

        async function totalValue() {
            return (Number((await fetch())[7][1]) / 10**18);
        }

        async function balance() {
            return (Number((await fetch())[4]) / 10**18);
        }

        async function fetch() {
            let assetStruct = "uint8,(address,address),address,address,uint256,uint8,uint8,(uint8,uint256)";
            let result = (await machine.query({
                to: engine,
                methodSignature: `function testFetch(address,address,address,address) external view returns (${assetStruct})`,
                methodName: "testFetch",
                methodArgs: [
                    factory,
                    router,
                    wmatic,
                    usdc
                ]
            })).unwrap() as any;
            return result;
        }

        async function transfer(value: number) {
            (await machine.invoke({
                to: wmatic,
                methodSignature: "function transfer(address,uint256) external",
                methodName: "transfer",
                methodArgs: [
                    engine,
                    BigInt(value * 10**18)
                ]
            })).unwrap();
        }
    })();

    async function deploySolFile(path: string, ...args: unknown[]): Promise<TsResult.Option<string>> {
        let file = File(Path(path));
        let contractName = file.name().unwrapOr("UnknownContract");
        let sol = SolFile(Path(path));
        if (sol.err) {
            err(contractName + ": unable to build sol file");
            err(contractName + ": " + sol.toString());
            return TsResult.None;
        }
        let errors = sol.unwrap().errors();
        if (errors.err) {
            err(contractName + ": unable to generate errors");
            err(contractName + ": " + errors.toString());
            return TsResult.None;
        }
        if (errors.unwrap().length != 0) {
            err(contractName + ": has source code errors");
            errors.unwrap().forEach(error => err(contractName + ": " + error));
            return TsResult.None;
        }
        let bytecode = sol.unwrap().bytecode();
        if (bytecode.err) {
            err(contractName + ": unable to generate bytecode");
            err(contractName + ": " + bytecode.toString());
            return TsResult.None;
        }
        let abi = sol.unwrap().abi();
        if (abi.err) {
            err(contractName + ": unable to generate abi");
            err(contractName + ": " + abi.toString());
            return TsResult.None;
        }
        return await deploy(contractName, bytecode.unwrap(), abi.unwrap(), args);
    }

    async function deploy(contractName: string, bytecode: string, abi?: object[] | string[], ...args: unknown[]): Promise<TsResult.Option<string>> {
        let deployment = await machine.deploy({ bytecode, abi, args });
        if (deployment.err) {
            err(contractName + ": unable to deploy");
            err(contractName + ": " + deployment.toString());
            return TsResult.None;
        }
        let address = deployment.unwrap()?.contractAddress;
        if (!address) {
            err(contractName + ": may have been deployed but did not return an address");
            return TsResult.None;
        }
        return TsResult.Some(address);
    }

    function log(...any: any[]) {
        return console.log(...any);
    }
    
    function err(...any: any[]) {
        return console.error(...any);
    }
})();

