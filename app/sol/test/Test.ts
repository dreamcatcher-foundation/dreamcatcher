import { EthereumVirtualMachine } from "../../class/ethereumVirtualMachine/EthereumVirtualMachine.ts";
import { ethers as Ethers } from "ethers";
import { secret } from "../../class/host/Secret.ts";
import { File } from "../../class/host/file/File.ts";
import { Path } from "../../class/host/Path.ts";
import * as TsResult from "ts-results";

(async function() {
    let mainnetNodeUrl = "https://polygon-rpc.com";
    let testnetNodeUrl =  "https://rpc.tenderly.co/fork/ca9185f3-d050-4189-90b5-53d35e920601";
    let nodeUrl = testnetNodeUrl;
    let key = secret("polygonPrivateKey");
    if (key.none) {
        err("MISSING_PRIVATE_KEY");
        return;
    }
    let node = new Ethers.JsonRpcProvider(nodeUrl);
    let signer = new Ethers.Wallet(key.unwrap(), node);
    let machine = EthereumVirtualMachine(signer);

    await (async function() {
        class AddressBook {
            public static readonly factory = "0x5757371414417b8C6CAad45bAeF941aBc7d3Ab32";
            public static readonly router = "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff";
            public static readonly usdc = "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359";
            public static readonly weth = "0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619";
            public static readonly wbtc = "0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6";
            public static readonly link = "0x53E0bca35eC356BD5ddDFebbD1Fc0fD03FaBad39";
            public static readonly wmatic = "0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270";
        }

        let tokens = {
            usdc: "0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359",
            weth: "0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619",
            wbtc: "0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6",
            link: "0x53E0bca35eC356BD5ddDFebbD1Fc0fD03FaBad39",
            wmatic: "0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270"
        };
        let factory = "0x5757371414417b8C6CAad45bAeF941aBc7d3Ab32";
        let router = "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff";
        let bytecode = "608060405234801561000f575f80fd5b50604051613c0a380380613c0a833981810160405281019061003191906101c0565b81815f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415801561009b57505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614155b6100da576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100d190610258565b60405180910390fd5b815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508060015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050505050610276565b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61018f82610166565b9050919050565b61019f81610185565b81146101a9575f80fd5b50565b5f815190506101ba81610196565b92915050565b5f80604083850312156101d6576101d5610162565b5b5f6101e3858286016101ac565b92505060206101f4858286016101ac565b9150509250929050565b5f82825260208201905092915050565b7f564f49445f494e505554000000000000000000000000000000000000000000005f82015250565b5f610242600a836101fe565b915061024d8261020e565b602082019050919050565b5f6020820190508181035f83015261026f81610236565b9050919050565b613987806102835f395ff3fe608060405234801561000f575f80fd5b5060043610610055575f3560e01c80633f3e37e41461005957806382c25d4c146100755780638672d545146100a5578063c45a0155146100d5578063f887ea40146100f3575b5f80fd5b610073600480360381019061006e9190612b77565b610111565b005b61008f600480360381019061008a9190612be3565b610ce2565b60405161009c9190612e8c565b60405180910390f35b6100bf60048036038101906100ba9190612eac565b610eaf565b6040516100cc9190612f97565b60405180910390f35b6100dd611516565b6040516100ea9190612fc6565b60405180910390f35b6100fb61153d565b6040516101089190612fc6565b60405180910390f35b5f61011c8484610ce2565b905061012a815f0151611565565b5f81602001516040015173ffffffffffffffffffffffffffffffffffffffff166370a08231336040518263ffffffff1660e01b815260040161016c9190612fc6565b602060405180830381865afa9250505080156101a657506040513d601f19601f820116820180604052508101906101a39190612ff3565b60015b61024e576101b261302a565b806308c379a0036101ea57506101c6613049565b806101d15750610228565b6101e26101dd8261157a565b611590565b505050610cdd565b634e487b7103610228576101fc6130d8565b906102075750610228565b61022061021b6102168361159c565b61157a565b611590565b505050610cdd565b61024761024260405180602001604052805f81525061157a565b611590565b5050610cdd565b5f8061026e8560200151608001516012856116669092919063ffffffff16565b9150915061027b82611565565b809350505050838110156102d0576102cf6102ca6040518060400160405280601481526020017f494e53554646494349454e545f42414c414e434500000000000000000000000081525061157a565b611590565b5b5f82602001516040015173ffffffffffffffffffffffffffffffffffffffff1663dd62ed3e33306040518363ffffffff1660e01b81526004016103149291906130f6565b602060405180830381865afa92505050801561034e57506040513d601f19601f8201168201806040525081019061034b9190612ff3565b60015b6103f15761035a61302a565b806308c379a003610390575061036e613049565b8061037957506103cc565b61038a6103858261157a565b611590565b506103ec565b634e487b71036103cc576103a26130d8565b906103ad57506103cc565b6103c66103c16103bc8361159c565b61157a565b611590565b506103ec565b6103eb6103e660405180602001604052805f81525061157a565b611590565b5b610425565b5f806104118660200151608001516012856116669092919063ffffffff16565b9150915061041e82611565565b8093505050505b848110156104745761047361046e6040518060400160405280601681526020017f494e53554646494349454e545f414c4c4f57414e43450000000000000000000081525061157a565b611590565b5b5f805f61049560128760200151608001518a6116669092919063ffffffff16565b915091506104a282611565565b809250505083602001516040015173ffffffffffffffffffffffffffffffffffffffff166323b872dd3330896040518463ffffffff1660e01b81526004016104ec9392919061312c565b6020604051808303815f875af192505050801561052757506040513d601f19601f82011682018060405250810190610524919061318b565b60015b6105ca5761053361302a565b806308c379a0036105695750610547613049565b8061055257506105a5565b61056361055e8261157a565b611590565b506105c5565b634e487b71036105a55761057b6130d8565b9061058657506105a5565b61059f61059a6105958361159c565b61157a565b611590565b506105c5565b6105c46105bf60405180602001604052805f81525061157a565b611590565b5b610618565b80610616576106156106106040518060400160405280600e81526020017f4641494c45445f5041594d454e5400000000000000000000000000000000000081525061157a565b611590565b5b505b83602001516040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b361064461153d565b5f6040518363ffffffff1660e01b81526004016106629291906131f8565b6020604051808303815f875af192505050801561069d57506040513d601f19601f8201168201806040525081019061069a919061318b565b60015b610740576106a961302a565b806308c379a0036106df57506106bd613049565b806106c8575061071b565b6106d96106d48261157a565b611590565b5061073b565b634e487b710361071b576106f16130d8565b906106fc575061071b565b61071561071061070b8361159c565b61157a565b611590565b5061073b565b61073a61073560405180602001604052805f81525061157a565b611590565b5b61078e565b8061078c5761078b6107866040518060400160405280601881526020017f4641494c45445f544f5f415050524f56455f524f55544552000000000000000081525061157a565b611590565b5b505b83602001516040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b36107ba61153d565b836040518363ffffffff1660e01b81526004016107d892919061321f565b6020604051808303815f875af192505050801561081357506040513d601f19601f82011682018060405250810190610810919061318b565b60015b6108b65761081f61302a565b806308c379a0036108555750610833613049565b8061083e5750610891565b61084f61084a8261157a565b611590565b506108b1565b634e487b7103610891576108676130d8565b906108725750610891565b61088b6108866108818361159c565b61157a565b611590565b506108b1565b6108b06108ab60405180602001604052805f81525061157a565b611590565b5b610904565b80610902576109016108fc6040518060400160405280601881526020017f4641494c45445f544f5f415050524f56455f524f55544552000000000000000081525061157a565b611590565b5b505b848460a001511115610957576109566109516040518060400160405280601a81526020017f534c4950504147455f455843454544535f5448524553484f4c4400000000000081525061157a565b611590565b5b5f61096061153d565b73ffffffffffffffffffffffffffffffffffffffff166338ed1739835f8b33426040518663ffffffff1660e01b81526004016109a09594939291906132ee565b5f604051808303815f875af19250505080156109de57506040513d5f823e3d601f19601f820116820180604052508101906109db9190613406565b60015b610a81576109ea61302a565b806308c379a003610a2057506109fe613049565b80610a095750610a5c565b610a1a610a158261157a565b611590565b50610a7c565b634e487b7103610a5c57610a326130d8565b90610a3d5750610a5c565b610a56610a51610a4c8361159c565b61157a565b611590565b50610a7c565b610a7b610a7660405180602001604052805f81525061157a565b611590565b5b610aad565b8060018251610a90919061347a565b81518110610aa157610aa06134ad565b5b60200260200101519150505b5f805f610ace886020015160a001516012866116669092919063ffffffff16565b91509150610adb82611565565b809250505085602001516040015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b3610b0c61153d565b5f6040518363ffffffff1660e01b8152600401610b2a9291906131f8565b6020604051808303815f875af1925050508015610b6557506040513d601f19601f82011682018060405250810190610b62919061318b565b60015b610c0857610b7161302a565b806308c379a003610ba75750610b85613049565b80610b905750610be3565b610ba1610b9c8261157a565b611590565b50610c03565b634e487b7103610be357610bb96130d8565b90610bc45750610be3565b610bdd610bd8610bd38361159c565b61157a565b611590565b50610c03565b610c02610bfd60405180602001604052805f81525061157a565b611590565b5b610c56565b80610c5457610c53610c4e6040518060400160405280601881526020017f4641494c45445f544f5f415050524f56455f524f55544552000000000000000081525061157a565b611590565b5b505b85602001516060015173ffffffffffffffffffffffffffffffffffffffff1686602001516040015173ffffffffffffffffffffffffffffffffffffffff167ffa2dda1cc1b86e41239702756b13effbc1a092b5c57e3ad320fbe4f3b13fe2358a84604051610cc59291906134da565b60405180910390a3610cd561177a565b505050505050505b505050565b610cea612884565b610cf2612884565b828160400181815250505f845f81518110610d1057610d0f6134ad565b5b602002602001015190505f8560018751610d2a919061347a565b81518110610d3b57610d3a6134ad565b5b602002602001015190505f610d508383610eaf565b9050805f01515f0151610d7457805f0151845f018190525083945050505050610ea9565b5f805f610d91601285608001518b6116669092919063ffffffff16565b91509150815f0151610db45781875f018190525086975050505050505050610ea9565b80925050505f805f610dcf8a8660c001518760e00151611795565b91509150815f0151610df35781885f01819052508798505050505050505050610ea9565b80925050505f805f610e058c86611995565b91509150815f0151610e2a5781895f0181905250889950505050505050505050610ea9565b80925050505f805f610e3c8486611bcc565b91509150815f0151610e6257818a5f0181905250899a5050505050505050505050610ea9565b8092505050610e6f61177a565b885f01819052508488602001819052508288606001818152505081886080018181525050808860a001818152505087985050505050505050505b92915050565b610eb76128c2565b610ebf6128c2565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161480610f2457505f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16145b15610f7757610f676040518060400160405280600a81526020017f564f49445f494e5055540000000000000000000000000000000000000000000081525061157a565b815f018190525080915050611510565b610f8084611cbf565b825f01836080018260ff1660ff168152508290525050805f01515f0151610faa5780915050611510565b610fb383611cbf565b825f018360a0018260ff1660ff168152508290525050805f01515f0151610fdd5780915050611510565b610fe5611516565b73ffffffffffffffffffffffffffffffffffffffff1663e6a4390585856040518363ffffffff1660e01b815260040161101f9291906130f6565b602060405180830381865afa92505050801561105957506040513d601f19601f820116820180604052508101906110569190613515565b60015b6111045761106561302a565b806308c379a00361109e5750611079613049565b8061108457506110dd565b61108d8161157a565b825f01819052508192505050611510565b634e487b71036110dd576110b06130d8565b906110bb57506110dd565b6110cc6110c78261159c565b61157a565b825f01819052508192505050611510565b6110f460405180602001604052805f81525061157a565b815f018190525080915050611510565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603611186576111756040518060400160405280600e81526020017f504149525f4e4f545f464f554e4400000000000000000000000000000000000081525061157a565b825f01819052508192505050611510565b80826020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050505f805f806111cc88611cbf565b91509150815f01516111ed5781855f01819052508495505050505050611510565b80935050505f806111fd87611cbf565b91509150815f015161121e5781855f01819052508495505050505050611510565b80925050505f805f805f6112358860200151611ddd565b925092509250825f015161125b5782885f01819052508798505050505050505050611510565b8194508093505050505f805f805f6112768a6020015161212d565b925092509250825f015161129e57828a5f0181905250899a5050505050505050505050611510565b8673ffffffffffffffffffffffffffffffffffffffff168d73ffffffffffffffffffffffffffffffffffffffff1603611380575f806112f98b6012866dffffffffffffffffffffffffffff166116669092919063ffffffff16565b91509150815f015161132157818c5f01819052508b9c50505050505050505050505050611510565b80965050505f8061134e8a6012856dffffffffffffffffffffffffffff166116669092919063ffffffff16565b91509150815f015161137657818c5f01819052508b9c50505050505050505050505050611510565b809550505061142b565b5f806113a88b6012856dffffffffffffffffffffffffffff166116669092919063ffffffff16565b91509150815f01516113d057818c5f01819052508b9c50505050505050505050505050611510565b80965050505f806113fd8a6012866dffffffffffffffffffffffffffff166116669092919063ffffffff16565b91509150815f015161142557818c5f01819052508b9c50505050505050505050505050611510565b80955050505b50505061143661177a565b875f018190525089876040019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505088876060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050818760c001906dffffffffffffffffffffffffffff1690816dffffffffffffffffffffffffffff1681525050808760e001906dffffffffffffffffffffffffffff1690816dffffffffffffffffffffffffffff1681525050869750505050505050505b92915050565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b5f60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b805f015161157757611576816122dc565b5b50565b61158261296e565b818160200181905250919050565b611599816122dc565b50565b60605f60016115aa8461231d565b0190505f8167ffffffffffffffff8111156115c8576115c76129ae565b5b6040519080825280601f01601f1916602001820160405280156115fa5781602001600182028036833780820191505090505b5090505f82602001820190505b60011561165b578080600190039150507f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a85816116505761164f613540565b5b0494505f8503611607575b819350505050919050565b61166e61296e565b5f60028460ff161080611684575060028360ff16105b80611692575060128460ff16115b806116a0575060128360ff16115b156116ed576116e36040518060400160405280601681526020017f444543494d414c535f4f55545f4f465f424f554e44530000000000000000000081525061157a565b5f91509150611772565b5f85148061170057508260ff168460ff16145b156117175761170d61177a565b8591509150611772565b5f8061174685600a611729919061369c565b87600a611736919061369c565b8961246e9092919063ffffffff16565b91509150815f015161175f57815f935093505050611772565b809650505061176c61177a565b85915091505b935093915050565b61178261296e565b6001815f01901515908115158152505090565b61179d61296e565b5f8085036117ed576117e36040518060400160405280601681526020017f494e53554646494349454e545f414d4f554e545f494e0000000000000000000081525061157a565b5f9150915061198d565b5f846dffffffffffffffffffffffffffff16148061181a57505f836dffffffffffffffffffffffffffff16145b156118675761185d6040518060400160405280601681526020017f494e53554646494349454e545f4c49515549444954590000000000000000000081525061157a565b5f9150915061198d565b61186f61153d565b73ffffffffffffffffffffffffffffffffffffffff1663ad615dec8686866040518463ffffffff1660e01b81526004016118ab93929190613716565b602060405180830381865afa9250505080156118e557506040513d601f19601f820116820180604052508101906118e29190612ff3565b60015b61197e576118f161302a565b806308c379a0036119245750611905613049565b80611910575061195d565b6119198161157a565b5f925092505061198d565b634e487b710361195d576119366130d8565b90611941575061195d565b61195261194d8261159c565b61157a565b5f925092505061198d565b61197460405180602001604052805f81525061157a565b5f9150915061198d565b61198661177a565b8192509250505b935093915050565b61199d61296e565b5f6119a661153d565b73ffffffffffffffffffffffffffffffffffffffff1663d06ca61f84866040518363ffffffff1660e01b81526004016119e092919061374b565b5f60405180830381865afa925050508015611a1d57506040513d5f823e3d601f19601f82011682018060405250810190611a1a9190613406565b60015b611ab657611a2961302a565b806308c379a003611a5c5750611a3d613049565b80611a485750611a95565b611a518161157a565b5f9250925050611bc5565b634e487b7103611a9557611a6e6130d8565b90611a795750611a95565b611a8a611a858261159c565b61157a565b5f9250925050611bc5565b611aac60405180602001604052805f81525061157a565b5f91509150611bc5565b5f8560018751611ac6919061347a565b81518110611ad757611ad66134ad565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa158015611b27573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611b4b91906137a3565b90505f8260018451611b5d919061347a565b81518110611b6e57611b6d6134ad565b5b602002602001015190505f805f611b91856012866116669092919063ffffffff16565b91509150815f0151611bae57815f97509750505050505050611bc5565b8092505050611bbb61177a565b8195509550505050505b9250929050565b611bd461296e565b5f8084148015611be457505f8314155b15611bfb57611bf161177a565b5f91509150611cb8565b5f8414158015611c0a57505f83145b15611c2a57611c1761177a565b68056bc75e2d6310000091509150611cb8565b5f84148015611c3857505f83145b15611c5857611c4561177a565b68056bc75e2d6310000091509150611cb8565b828410611c7a57611c6761177a565b68056bc75e2d6310000091509150611cb8565b5f80611c8f85876124f090919063ffffffff16565b91509150815f0151611ca857815f935093505050611cb8565b611cb061177a565b819350935050505b9250929050565b611cc761296e565b5f8273ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015611d3057506040513d601f19601f82011682018060405250810190611d2d91906137a3565b60015b611dc957611d3c61302a565b806308c379a003611d6f5750611d50613049565b80611d5b5750611da8565b611d648161157a565b5f9250925050611dd8565b634e487b7103611da857611d816130d8565b90611d8c5750611da8565b611d9d611d988261159c565b61157a565b5f9250925050611dd8565b611dbf60405180602001604052805f81525061157a565b5f91509150611dd8565b611dd161177a565b8192509250505b915091565b611de561296e565b5f805f808573ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015611e5157506040513d601f19601f82011682018060405250810190611e4e9190613515565b60015b611ef957611e5d61302a565b806308c379a003611e955750611e71613049565b80611e7c5750611ed3565b611e858161157a565b5f80955095509550505050612126565b634e487b7103611ed357611ea76130d8565b90611eb25750611ed3565b611ec3611ebe8261159c565b61157a565b5f80955095509550505050612126565b611eea60405180602001604052805f81525061157a565b5f809450945094505050612126565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603611f7a57611f6a6040518060400160405280600f81526020017f564f49445f504149525f544f4b454e000000000000000000000000000000000081525061157a565b5f80955095509550505050612126565b809250508573ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015611fe657506040513d601f19601f82011682018060405250810190611fe39190613515565b60015b61208e57611ff261302a565b806308c379a00361202a5750612006613049565b806120115750612068565b61201a8161157a565b5f80955095509550505050612126565b634e487b71036120685761203c6130d8565b906120475750612068565b6120586120538261159c565b61157a565b5f80955095509550505050612126565b61207f60405180602001604052805f81525061157a565b5f809450945094505050612126565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff160361210f576120ff6040518060400160405280600f81526020017f564f49445f504149525f544f4b454e000000000000000000000000000000000081525061157a565b5f80955095509550505050612126565b8091505061211b61177a565b828294509450945050505b9193909250565b61213561296e565b5f808373ffffffffffffffffffffffffffffffffffffffff16630902f1ac6040518163ffffffff1660e01b8152600401606060405180830381865afa92505050801561219f57506040513d601f19601f8201168201806040525081019061219c9190613831565b60015b612241576121ab61302a565b806308c379a0036121e157506121bf613049565b806121ca575061221d565b6121d38161157a565b5f80935093509350506122d5565b634e487b710361221d576121f36130d8565b906121fe575061221d565b61220f61220a8261159c565b61157a565b5f80935093509350506122d5565b61223460405180602001604052805f81525061157a565b5f809250925092506122d5565b5f836dffffffffffffffffffffffffffff16148061226e57505f826dffffffffffffffffffffffffffff16145b156122c1576122b16040518060400160405280601681526020017f494e53554646494349454e545f4c49515549444954590000000000000000000081525061157a565b5f809550955095505050506122d5565b6122c961177a565b83839550955095505050505b9193909250565b80602001516040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161231491906138c9565b60405180910390fd5b5f805f90507a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008310612379577a184f03e93ff9f4daa797ed6e38ed64bf6a1f010000000000000000838161236f5761236e613540565b5b0492506040810190505b6d04ee2d6d415b85acef810000000083106123b6576d04ee2d6d415b85acef810000000083816123ac576123ab613540565b5b0492506020810190505b662386f26fc1000083106123e557662386f26fc1000083816123db576123da613540565b5b0492506010810190505b6305f5e100831061240e576305f5e100838161240457612403613540565b5b0492506008810190505b612710831061243357612710838161242957612428613540565b5b0492506004810190505b60648310612456576064838161244c5761244b613540565b5b0492506002810190505b600a8310612465576001810190505b80915050919050565b61247661296e565b5f8083036124c6576124bc6040518060400160405280601081526020017f4449564953494f4e5f42595f5a45524f0000000000000000000000000000000081525061157a565b5f915091506124e8565b6124ce61177a565b6124e38585886125889092919063ffffffff16565b915091505b935093915050565b6124f861296e565b5f8068056bc75e2d6310000090505f805f61251c878961269290919063ffffffff16565b91509150815f015161253757815f9550955050505050612581565b80925050505f80612551838561272190919063ffffffff16565b91509150815f015161256c57815f9550955050505050612581565b809250505061257961177a565b819350935050505b9250929050565b5f805f80198587098587029250828110838203039150505f81036125c0578382816125b6576125b5613540565b5b049250505061268b565b808411612602576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016125f990613933565b60405180910390fd5b5f8486880990508281118203915080830392505f60018619018616905080860495508084049350600181825f0304019050808302841793505f600287600302189050808702600203810290508087026002038102905080870260020381029050808702600203810290508087026002038102905080870260020381029050808502955050505050505b9392505050565b61269a61296e565b5f8084036126b4576126aa61177a565b5f9150915061271a565b8284106126d6576126c361177a565b68056bc75e2d631000009150915061271a565b5f805f6126ec868861279190919063ffffffff16565b91509150815f015161270657815f9450945050505061271a565b809250505061271361177a565b8192509250505b9250929050565b61272961296e565b5f8383111561277a576127706040518060400160405280600a81526020017f55494e545f554e4445520000000000000000000000000000000000000000000081525061157a565b5f9150915061278a565b61278261177a565b838503915091505b9250929050565b61279961296e565b5f805f806127b0868861282290919063ffffffff16565b91509150815f01516127ca57815f9450945050505061281b565b80925050505f806127ed68056bc75e2d631000008461285390919063ffffffff16565b91509150815f015161280757815f9450945050505061281b565b809250505061281461177a565b8192509250505b9250929050565b61282a61296e565b5f612848670de0b6b3a7640000848661246e9092919063ffffffff16565b915091509250929050565b61285b61296e565b5f61287983670de0b6b3a76400008661246e9092919063ffffffff16565b915091509250929050565b6040518060c0016040528061289761296e565b81526020016128a46128c2565b81526020015f81526020015f81526020015f81526020015f81525090565b6040518061010001604052806128d661296e565b81526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f60ff1681526020015f60ff1681526020015f6dffffffffffffffffffffffffffff1681526020015f6dffffffffffffffffffffffffffff1681525090565b60405180604001604052805f15158152602001606081525090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6129e48261299e565b810181811067ffffffffffffffff82111715612a0357612a026129ae565b5b80604052505050565b5f612a15612989565b9050612a2182826129db565b919050565b5f67ffffffffffffffff821115612a4057612a3f6129ae565b5b602082029050602081019050919050565b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f612a7e82612a55565b9050919050565b612a8e81612a74565b8114612a98575f80fd5b50565b5f81359050612aa981612a85565b92915050565b5f612ac1612abc84612a26565b612a0c565b90508083825260208201905060208402830185811115612ae457612ae3612a51565b5b835b81811015612b0d5780612af98882612a9b565b845260208401935050602081019050612ae6565b5050509392505050565b5f82601f830112612b2b57612b2a61299a565b5b8135612b3b848260208601612aaf565b91505092915050565b5f819050919050565b612b5681612b44565b8114612b60575f80fd5b50565b5f81359050612b7181612b4d565b92915050565b5f805f60608486031215612b8e57612b8d612992565b5b5f84013567ffffffffffffffff811115612bab57612baa612996565b5b612bb786828701612b17565b9350506020612bc886828701612b63565b9250506040612bd986828701612b63565b9150509250925092565b5f8060408385031215612bf957612bf8612992565b5b5f83013567ffffffffffffffff811115612c1657612c15612996565b5b612c2285828601612b17565b9250506020612c3385828601612b63565b9150509250929050565b5f8115159050919050565b612c5181612c3d565b82525050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f612c8982612c57565b612c938185612c61565b9350612ca3818560208601612c71565b612cac8161299e565b840191505092915050565b5f604083015f830151612ccc5f860182612c48565b5060208301518482036020860152612ce48282612c7f565b9150508091505092915050565b612cfa81612a74565b82525050565b5f60ff82169050919050565b612d1581612d00565b82525050565b5f6dffffffffffffffffffffffffffff82169050919050565b612d3d81612d1b565b82525050565b5f61010083015f8301518482035f860152612d5e8282612cb7565b9150506020830151612d736020860182612cf1565b506040830151612d866040860182612cf1565b506060830151612d996060860182612cf1565b506080830151612dac6080860182612d0c565b5060a0830151612dbf60a0860182612d0c565b5060c0830151612dd260c0860182612d34565b5060e0830151612de560e0860182612d34565b508091505092915050565b612df981612b44565b82525050565b5f60c083015f8301518482035f860152612e198282612cb7565b91505060208301518482036020860152612e338282612d43565b9150506040830151612e486040860182612df0565b506060830151612e5b6060860182612df0565b506080830151612e6e6080860182612df0565b5060a0830151612e8160a0860182612df0565b508091505092915050565b5f6020820190508181035f830152612ea48184612dff565b905092915050565b5f8060408385031215612ec257612ec1612992565b5b5f612ecf85828601612a9b565b9250506020612ee085828601612a9b565b9150509250929050565b5f61010083015f8301518482035f860152612f058282612cb7565b9150506020830151612f1a6020860182612cf1565b506040830151612f2d6040860182612cf1565b506060830151612f406060860182612cf1565b506080830151612f536080860182612d0c565b5060a0830151612f6660a0860182612d0c565b5060c0830151612f7960c0860182612d34565b5060e0830151612f8c60e0860182612d34565b508091505092915050565b5f6020820190508181035f830152612faf8184612eea565b905092915050565b612fc081612a74565b82525050565b5f602082019050612fd95f830184612fb7565b92915050565b5f81519050612fed81612b4d565b92915050565b5f6020828403121561300857613007612992565b5b5f61301584828501612fdf565b91505092915050565b5f8160e01c9050919050565b5f60033d11156130465760045f803e6130435f5161301e565b90505b90565b5f60443d106130d55761305a612989565b60043d036004823e80513d602482011167ffffffffffffffff821117156130825750506130d5565b808201805167ffffffffffffffff8111156130a057505050506130d5565b80602083010160043d0385018111156130bd5750505050506130d5565b6130cc826020018501866129db565b82955050505050505b90565b5f8060233d11156130f257602060045f3e600191505f5190505b9091565b5f6040820190506131095f830185612fb7565b6131166020830184612fb7565b9392505050565b61312681612b44565b82525050565b5f60608201905061313f5f830186612fb7565b61314c6020830185612fb7565b613159604083018461311d565b949350505050565b61316a81612c3d565b8114613174575f80fd5b50565b5f8151905061318581613161565b92915050565b5f602082840312156131a05761319f612992565b5b5f6131ad84828501613177565b91505092915050565b5f819050919050565b5f819050919050565b5f6131e26131dd6131d8846131b6565b6131bf565b612b44565b9050919050565b6131f2816131c8565b82525050565b5f60408201905061320b5f830185612fb7565b61321860208301846131e9565b9392505050565b5f6040820190506132325f830185612fb7565b61323f602083018461311d565b9392505050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f61327a8383612cf1565b60208301905092915050565b5f602082019050919050565b5f61329c82613246565b6132a68185613250565b93506132b183613260565b805f5b838110156132e15781516132c8888261326f565b97506132d383613286565b9250506001810190506132b4565b5085935050505092915050565b5f60a0820190506133015f83018861311d565b61330e60208301876131e9565b81810360408301526133208186613292565b905061332f6060830185612fb7565b61333c608083018461311d565b9695505050505050565b5f67ffffffffffffffff8211156133605761335f6129ae565b5b602082029050602081019050919050565b5f61338361337e84613346565b612a0c565b905080838252602082019050602084028301858111156133a6576133a5612a51565b5b835b818110156133cf57806133bb8882612fdf565b8452602084019350506020810190506133a8565b5050509392505050565b5f82601f8301126133ed576133ec61299a565b5b81516133fd848260208601613371565b91505092915050565b5f6020828403121561341b5761341a612992565b5b5f82015167ffffffffffffffff81111561343857613437612996565b5b613444848285016133d9565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61348482612b44565b915061348f83612b44565b92508282039050818111156134a7576134a661344d565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f6040820190506134ed5f83018561311d565b6134fa602083018461311d565b9392505050565b5f8151905061350f81612a85565b92915050565b5f6020828403121561352a57613529612992565b5b5f61353784828501613501565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f8160011c9050919050565b5f808291508390505b60018511156135c25780860481111561359e5761359d61344d565b5b60018516156135ad5780820291505b80810290506135bb8561356d565b9450613582565b94509492505050565b5f826135da5760019050613695565b816135e7575f9050613695565b81600181146135fd576002811461360757613636565b6001915050613695565b60ff8411156136195761361861344d565b5b8360020a9150848211156136305761362f61344d565b5b50613695565b5060208310610133831016604e8410600b841016171561366b5782820a9050838111156136665761366561344d565b5b613695565b6136788484846001613579565b9250905081840481111561368f5761368e61344d565b5b81810290505b9392505050565b5f6136a682612b44565b91506136b183612d00565b92506136de7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff84846135cb565b905092915050565b5f6137006136fb6136f684612d1b565b6131bf565b612b44565b9050919050565b613710816136e6565b82525050565b5f6060820190506137295f83018661311d565b6137366020830185613707565b6137436040830184613707565b949350505050565b5f60408201905061375e5f83018561311d565b81810360208301526137708184613292565b90509392505050565b61378281612d00565b811461378c575f80fd5b50565b5f8151905061379d81613779565b92915050565b5f602082840312156137b8576137b7612992565b5b5f6137c58482850161378f565b91505092915050565b6137d781612d1b565b81146137e1575f80fd5b50565b5f815190506137f2816137ce565b92915050565b5f63ffffffff82169050919050565b613810816137f8565b811461381a575f80fd5b50565b5f8151905061382b81613807565b92915050565b5f805f6060848603121561384857613847612992565b5b5f613855868287016137e4565b9350506020613866868287016137e4565b92505060406138778682870161381d565b9150509250925092565b5f82825260208201905092915050565b5f61389b82612c57565b6138a58185613881565b93506138b5818560208601612c71565b6138be8161299e565b840191505092915050565b5f6020820190508181035f8301526138e18184613891565b905092915050565b7f4d6174683a206d756c446976206f766572666c6f7700000000000000000000005f82015250565b5f61391d601583613881565b9150613928826138e9565b602082019050919050565b5f6020820190508181035f83015261394a81613911565b905091905056fea26469706673582212202eb210e757674d6691f03cc5baede0493b8b55a4f1daa1c4ac07d8c21285423664736f6c63430008190033" as const;
        let abi = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "factory",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "router",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "tokenIn",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "tokenOut",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amountOut",
                        "type": "uint256"
                    }
                ],
                "name": "Swap",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "factory",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token0",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "token1",
                        "type": "address"
                    }
                ],
                "name": "pair",
                "outputs": [
                    {
                        "components": [
                            {
                                "components": [
                                    {
                                        "internalType": "bool",
                                        "name": "ok",
                                        "type": "bool"
                                    },
                                    {
                                        "internalType": "string",
                                        "name": "code",
                                        "type": "string"
                                    }
                                ],
                                "internalType": "struct Result",
                                "name": "result",
                                "type": "tuple"
                            },
                            {
                                "internalType": "address",
                                "name": "addr",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "token0",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "token1",
                                "type": "address"
                            },
                            {
                                "internalType": "uint8",
                                "name": "decimals0",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint8",
                                "name": "decimals1",
                                "type": "uint8"
                            },
                            {
                                "internalType": "uint112",
                                "name": "reserve0",
                                "type": "uint112"
                            },
                            {
                                "internalType": "uint112",
                                "name": "reserve1",
                                "type": "uint112"
                            }
                        ],
                        "internalType": "struct Pair",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address[]",
                        "name": "path",
                        "type": "address[]"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    }
                ],
                "name": "quote",
                "outputs": [
                    {
                        "components": [
                            {
                                "components": [
                                    {
                                        "internalType": "bool",
                                        "name": "ok",
                                        "type": "bool"
                                    },
                                    {
                                        "internalType": "string",
                                        "name": "code",
                                        "type": "string"
                                    }
                                ],
                                "internalType": "struct Result",
                                "name": "result",
                                "type": "tuple"
                            },
                            {
                                "components": [
                                    {
                                        "components": [
                                            {
                                                "internalType": "bool",
                                                "name": "ok",
                                                "type": "bool"
                                            },
                                            {
                                                "internalType": "string",
                                                "name": "code",
                                                "type": "string"
                                            }
                                        ],
                                        "internalType": "struct Result",
                                        "name": "result",
                                        "type": "tuple"
                                    },
                                    {
                                        "internalType": "address",
                                        "name": "addr",
                                        "type": "address"
                                    },
                                    {
                                        "internalType": "address",
                                        "name": "token0",
                                        "type": "address"
                                    },
                                    {
                                        "internalType": "address",
                                        "name": "token1",
                                        "type": "address"
                                    },
                                    {
                                        "internalType": "uint8",
                                        "name": "decimals0",
                                        "type": "uint8"
                                    },
                                    {
                                        "internalType": "uint8",
                                        "name": "decimals1",
                                        "type": "uint8"
                                    },
                                    {
                                        "internalType": "uint112",
                                        "name": "reserve0",
                                        "type": "uint112"
                                    },
                                    {
                                        "internalType": "uint112",
                                        "name": "reserve1",
                                        "type": "uint112"
                                    }
                                ],
                                "internalType": "struct Pair",
                                "name": "pair",
                                "type": "tuple"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amountIn",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "bestAmountOut",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "realAmountOut",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "slippage",
                                "type": "uint256"
                            }
                        ],
                        "internalType": "struct Quote",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "router",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address[]",
                        "name": "path",
                        "type": "address[]"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "slippageThreshold",
                        "type": "uint256"
                    }
                ],
                "name": "swap",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "bool",
                                "name": "ok",
                                "type": "bool"
                            },
                            {
                                "internalType": "string",
                                "name": "code",
                                "type": "string"
                            }
                        ],
                        "internalType": "struct Result",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];
        let adaptor: string = ((await (machine.deploy({
            bytecode, 
            abi,
            args: [
                factory,
                router
            ]
        }))).unwrap())?.contractAddress!;

        async function signerAccount(): Promise<string> {
            return await signer.getAddress();
        }

        async function decimals(erc20: string): Promise<number> {
            return Number((await machine.query({
                to: erc20,
                methodSignature: "function decimals() external view returns (uint8)",
                methodName: "decimals"
            })).unwrap() as bigint);
        }

        async function balance(account: string, erc20: string) {
            return Number((await machine.query({
                to: erc20,
                methodSignature: "function balanceOf(address) external view returns (uint256)",
                methodName: "balanceOf",
                methodArgs: [account]
            })).unwrap() as bigint) / (10**await decimals(erc20));
        }

        async function myBalance(erc20: string): Promise<number> {
            return await balance(await signerAccount(), erc20);
        }

        await (async function() {
            let token0 = tokens.link;
            let token1 = tokens.weth;
            let amount = 1000;
            let slippageThreshold = 5;

            let pair = (await machine.query({
                to: adaptor,
                methodSignature: "function pair(address,address) external view returns (tuple(tuple(bool,string),address,address,address,uint8,uint8,uint112,uint112))",
                methodName: "pair",
                methodArgs: [
                    token0,
                    token1
                ]
            })).unwrap() as any[];

            let quote = (await machine.query({
                to: adaptor,
                methodSignature: `function quote(address[],uint256) external view returns (tuple(tuple(bool,string),tuple(tuple(bool,string),address,address,address,uint8,uint8,uint112,uint112),uint256,uint256,uint256,uint256))`,
                methodName: "quote",
                methodArgs: [
                    [
                        token0,
                        token1
                    ], 
                    BigInt(amount * 10**18)
                ]
            })).unwrap() as any[];

            log("best: ", format(quote[3]));
            log("real: ", format(quote[4]));
            log("slippage: ", format(quote[5]));

            let balanceThen = await myBalance(token0);
            let cashThen = await myBalance(token1);

            (await machine.invoke({
                to: token0,
                methodSignature: "function approve(address,uint256) external view returns (bool)",
                methodName: "approve",
                methodArgs: [
                    adaptor,
                    BigInt(amount * 10**18)
                ]
            })).unwrap();

            (await machine.invoke({
                to: adaptor,
                methodSignature: `function swap(address[],uint256,uint256) external view returns (bool,string)`,
                methodName: "swap",
                methodArgs: [
                    [
                        token0,
                        token1
                    ], 
                    BigInt(amount * 10**18),
                    BigInt(slippageThreshold * 10**18)
                ]
            })).unwrap();

            let balanceNow = await myBalance(token0);
            let cashNow = await myBalance(token1);

            log("link taken from balance", balanceThen - balanceNow);
            log("usdc gained", cashNow - cashThen); 
        })();
    })();
})();

function log(...any: any[]) {
    return console.log(...any);
}

function err(...any: any[]) {
    return console.error(...any);
}

function format(any: any) {
    return Number(any) / 10**18
}